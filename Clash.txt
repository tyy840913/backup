// å›½å†…DNSæœåŠ¡å™¨
const domesticNameservers = [
  "https://223.5.5.5/dns-query", // é˜¿é‡ŒDoH
  "https://doh.pub/dns-query" // è…¾è®¯DoHï¼Œå› è…¾è®¯äº‘å³å°†å…³é—­å…è´¹ç‰ˆIPè®¿é—®ï¼Œæ•…ç”¨åŸŸå
];

// å›½å¤–DNSæœåŠ¡å™¨
const foreignNameservers = [
  "https://cloudflare-dns.com/dns-query", // CloudflareDNS
  "https://77.88.8.8/dns-query", // YandexDNS
  "https://8.8.4.4/dns-query#ecs=1.1.1.1/24&ecs-override=true", // GoogleDNS
  "https://208.67.222.222/dns-query#ecs=1.1.1.1/24&ecs-override=true", // OpenDNS
  "https://9.9.9.9/dns-query", // Quad9DNS
];

// DNSé…ç½®
const dnsConfig = {
  "enable": true, // å¯ç”¨DNS
  "listen": "0.0.0.0:1053", // ç›‘å¬åœ°å€å’Œç«¯å£
  "ipv6": true, // æ”¯æŒIPv6
  "prefer-h3": true, // ä¼˜å…ˆä½¿ç”¨HTTP/3
  "respect-rules": true, // éµå¾ªè§„åˆ™
  "use-system-hosts": false, // ä¸ä½¿ç”¨ç³»ç»Ÿhostsæ–‡ä»¶
  "cache-algorithm": "arc", // ç¼“å­˜ç®—æ³•
  "enhanced-mode": "fake-ip", // å¢å¼ºæ¨¡å¼ï¼šä¼ªIP
  "fake-ip-range": "198.18.0.1/16", // ä¼ªIPåœ°å€èŒƒå›´
  "fake-ip-filter": [ // ä¼ªIPè¿‡æ»¤è§„åˆ™
    // æœ¬åœ°ä¸»æœº/è®¾å¤‡
    "+.lan",
    "+.local",
    // Windowsç½‘ç»œå‡ºç°å°åœ°çƒå›¾æ ‡
    "+.msftconnecttest.com",
    "+.msftncsi.com",
    // QQå¿«é€Ÿç™»å½•æ£€æµ‹å¤±è´¥
    "localhost.ptlogin2.qq.com",
    "localhost.sec.qq.com",
    // å¾®ä¿¡å¿«é€Ÿç™»å½•æ£€æµ‹å¤±è´¥
    "localhost.work.weixin.qq.com"
  ],
  "default-nameserver": ["223.5.5.5", "1.2.4.8"], // é»˜è®¤DNSæœåŠ¡å™¨
  "nameserver": [...foreignNameservers], // å›½å¤–DNSæœåŠ¡å™¨
  "proxy-server-nameserver": [...domesticNameservers], // ä»£ç†æœåŠ¡å™¨DNS
  "direct-nameserver": [...domesticNameservers], // ç›´è¿DNS
  "direct-nameserver-follow-policy": false, // ç›´è¿DNSä¸éµå¾ªç­–ç•¥
  "nameserver-policy": {
    "geosite:cn": domesticNameservers // ä¸­å›½ç«™ç‚¹ä½¿ç”¨å›½å†…DNS
  }
};
// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = {
  "type": "http",
  "format": "yaml",
  "interval": 86400
};

// è§„åˆ™é›†é…ç½®
const ruleProviders = {
  "LocalAreaNetwork": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/LocalAreaNetwork.list",
    "path": "./ruleset/LocalAreaNetwork.list",
    "behavior": "classical"
  },
  "ChinaDomain": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/ChinaDomain.list",
    "path": "./ruleset/ChinaDomain.list",
    "behavior": "classical"
  },
  "ChinaCompanyIp": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/ChinaCompanyIp.list",
    "path": "./ruleset/ChinaCompanyIp.list",
    "behavior": "classical"
  },
  "UnBan": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/UnBan.list",
    "path": "./ruleset/UnBan.list",
    "behavior": "classical"
  },
  "ProxyLite": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/Ruleset/ProxyLite.list",
    "path": "./ruleset/ProxyLite.list",
    "behavior": "classical"
  },
  "ChinaMedia": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/ChinaMedia.list",
    "path": "./ruleset/ChinaMedia.list",
    "behavior": "classical"
  },
  "Download": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://testingcf.jsdelivr.net/gh/ACL4SSR/ACL4SSR@master/Clash/Download.list",
    "path": "./ruleset/Download.list",
    "behavior": "classical"
  },
  "Tomato": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://cdn.jsdelivr.net/gh/tyy840913/backup/Tomato.list",
    "path": "./ruleset/Tomato.list",
    "behavior": "classical"
  }
};

//è§„åˆ™
const rules = [
   "RULE-SET,Tomato,ğŸ›‘ å¹¿å‘Šæ‹¦æˆª",
   "PROCESS-NAME,subs-check.exe,ğŸ¯ å…¨çƒç›´è¿",
   "PROCESS-NAME,subs-check,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,LocalAreaNetwork,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,UnBan,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,ChinaDomain,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,ProxyLite,ğŸ“¹ å…¨çƒä»£ç†",
   "RULE-SET,ChinaMedia,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,ChinaDomain,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,ChinaCompanyIp,ğŸ¯ å…¨çƒç›´è¿",
   "RULE-SET,Download,ğŸ¯ å…¨çƒç›´è¿",
   "GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿",
   "MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼"
];

// ä»£ç†ç»„é€šç”¨é…ç½®
const groupBaseOption = {
  "interval": 300,
  "timeout": 3000,
  "url": "https://www.google.com/generate_204",
  "lazy": true,
  "max-failed-times": 3,
  "hidden": false
};

// ç¨‹åºå…¥å£
function main(config, profileName) {
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0;
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†");
  }

  // è¦†ç›–åŸé…ç½®ä¸­DNSé…ç½®
  config["dns"] = dnsConfig;
  
  // è¦†ç›–åŸé…ç½®ä¸­çš„ä»£ç†ç»„
  config["proxy-groups"] = [
  {
    ...groupBaseOption,
    "name": "ğŸš€ èŠ‚ç‚¹é€‰æ‹©",
    "type": "select",
    "proxies": ["â™» è‡ªåŠ¨é€‰æ‹©", "ğŸš€ è´Ÿè½½å‡è¡¡", "ğŸš€ æ‰‹åŠ¨åˆ‡æ¢", "DIRECT"]
  },
  {
    ...groupBaseOption,
    "name": "ğŸš€ æ‰‹åŠ¨åˆ‡æ¢",
    "type": "select",
    "include-all": true
  },
  {
    ...groupBaseOption,
    "name": "â™» è‡ªåŠ¨é€‰æ‹©",
    "type": "url-test",
    "include-all": true,
    "interval": 300,
    "tolerance": 50
  },
  {
    ...groupBaseOption,
    "name": "ğŸš€ è´Ÿè½½å‡è¡¡",
    "type": "load-balance",
    "include-all": true,
    "interval": 300,
    "strategy": "round-robin"
  },
  {
    ...groupBaseOption,
    "name": "ğŸ“¹ å…¨çƒä»£ç†",
    "type": "select",
    "proxies": ["ğŸš€ èŠ‚ç‚¹é€‰æ‹©", "â™» è‡ªåŠ¨é€‰æ‹©", "ğŸš€ æ‰‹åŠ¨åˆ‡æ¢", "DIRECT"]
  },
  {
    ...groupBaseOption,
    "name": "ğŸ¯ å…¨çƒç›´è¿",
    "type": "select",
    "proxies": ["DIRECT", "ğŸš€ èŠ‚ç‚¹é€‰æ‹©", "â™» è‡ªåŠ¨é€‰æ‹©"]
  },
  {
    ...groupBaseOption,
    "name": "ğŸ›‘ å¹¿å‘Šæ‹¦æˆª",
    "type": "select",
    "proxies": ["REJECT", "DIRECT"]
  },
  {
    ...groupBaseOption,
    "name": "ğŸŸ æ¼ç½‘ä¹‹é±¼",
    "type": "select",
    "proxies": ["ğŸš€ èŠ‚ç‚¹é€‰æ‹©", "â™» è‡ªåŠ¨é€‰æ‹©", "DIRECT", "ğŸš€ æ‰‹åŠ¨åˆ‡æ¢"]
  }
];

  // è¦†ç›–åŸé…ç½®ä¸­çš„è§„åˆ™
  config["rule-providers"] = ruleProviders;
  config["rules"] = rules;

  // è¿”å›ä¿®æ”¹åçš„é…ç½®
  return config;
}
