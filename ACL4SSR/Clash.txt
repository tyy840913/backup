// ========== å›½å†… DoH ==========
const domesticNameservers = [
  "https://223.5.5.5/dns-query",          // é˜¿é‡Œ-A | å›½å†…æœ€å¿«ä¹‹ä¸€ï¼Œæ”¯æŒ ECS
  "https://223.6.6.6/dns-query",          // é˜¿é‡Œ-B | åŒä¸Šä¸€è‡´ï¼ŒåŒèŠ‚ç‚¹è´Ÿè½½
  "https://119.29.29.29/dns-query",       // è…¾è®¯ä¸» | DNSPod å›½å†…å…¥å£ï¼ŒèŠ‚ç‚¹å¤šã€å»¶è¿Ÿä½
  "https://doh.pub/dns-query",            // è…¾è®¯åŸŸ | å¤‡æ¡ˆåŸŸåè®¿é—®ï¼ŒIP å°æ—¶æ•‘åœº
  "https://1.12.12.12/dns-query",         // è…¾è®¯å¤‡ | çº¯ IP å¤‡ç”¨ï¼Œå»¶è¿ŸåŒ 119 ç›¸è¿‘
  "https://120.53.53.53/dns-query",       // è…¾è®¯ä¸‰ | åˆä¸€ Anycastï¼Œä¸‰èŠ‚ç‚¹äº’ä¸ºå…œåº•
  "https://114.114.114.114/dns-query"     // 114DNS | è€ç‰Œçº¯å‡€ï¼Œæ— å¹¿å‘Šï¼Œç¨³å®š 10 å¹´+
];

// ========== å›½å¤– DoH ==========
const foreignNameservers = [
  "https://cloudflare-dns.com/dns-query", // CF åŸŸå | å…¨çƒ Anycastï¼Œéšç§ä¼˜å…ˆï¼Œæ— æ—¥å¿—
  "https://1.1.1.1/dns-query",            // CF-1   | çº¯ IP å…¥å£ï¼Œå»¶è¿Ÿä½
  "https://1.0.0.1/dns-query",            // CF-2   | Cloudflare å¤‡ç”¨ï¼ŒåŒ A å¤‡ä»½
  "https://dns.google/dns-query",         // Google | è‡ªåŠ¨è´Ÿè½½ 8.8.8.8/8.8.4.4ï¼Œæ”¯æŒ ECS
  "https://8.8.8.8/dns-query",            // G-ä¸»   | æœ€å¸¸ç”¨ï¼Œè§£ææƒå¨ï¼ŒæŠ—æ±¡æŸ“
  "https://8.8.4.4/dns-query",            // G-å¤‡   | åŒä¸Šï¼ŒåŒèŠ‚ç‚¹å†—ä½™
  "https://dns.quad9.net/dns-query",      // Quad9  | è‡ªå¸¦æ¶æ„åŸŸæ‹¦æˆªï¼Œéšç§è®¤è¯
  "https://9.9.9.9/dns-query",            // Q9-ä¸»  | çº¯ IPï¼Œå®‰å…¨è¿‡æ»¤
  "https://dns11.quad9.net/dns-query",    // Q9-å¤‡  | æ¬¡çº§èŠ‚ç‚¹ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢
  "https://dns.yandex.com/dns-query",     // Yandex | ä¸œæ¬§/ä¸­äºšä¼˜åŒ–ï¼Œå›½å†…å¶å°”æŠ½é£
  "https://77.88.8.8/dns-query"           // Y-å¤‡   | çº¯ IP å…¥å£ï¼Œå…œåº•ä½¿ç”¨
];

// DNSé…ç½®
const dnsConfig = {
  "enable": true, // å¯ç”¨DNS
  "listen": "0.0.0.0:1053", // ç›‘å¬åœ°å€å’Œç«¯å£
  "ipv6": true, // æ”¯æŒIPv6
  "prefer-h3": true, // ä¼˜å…ˆä½¿ç”¨HTTP/3
  "respect-rules": true, // éµå¾ªè§„åˆ™
  "use-system-hosts": false, // ä¸ä½¿ç”¨ç³»ç»Ÿhostsæ–‡ä»¶
  "cache-algorithm": "arc", // ç¼“å­˜ç®—æ³•
  "enhanced-mode": "fake-ip", // å¢å¼ºæ¨¡å¼ï¼šä¼ªIP
  "fake-ip-range": "198.18.0.1/16", // ä¼ªIPåœ°å€èŒƒå›´
  "fake-ip-filter": [ // ä¼ªIPè¿‡æ»¤è§„åˆ™
    // æœ¬åœ°ä¸»æœº/è®¾å¤‡
    "+.lan",
    "+.local",
    // Windowsç½‘ç»œå‡ºç°å°åœ°çƒå›¾æ ‡
    "+.msftconnecttest.com",
    "+.msftncsi.com",
    // QQå¿«é€Ÿç™»å½•æ£€æµ‹å¤±è´¥
    "localhost.ptlogin2.qq.com",
    "localhost.sec.qq.com",
    // å¾®ä¿¡å¿«é€Ÿç™»å½•æ£€æµ‹å¤±è´¥
    "localhost.work.weixin.qq.com"
  ],
  "default-nameserver": ["223.5.5.5","1.2.4.8","114.114.114.114","119.29.29.29"], // é»˜è®¤DNSæœåŠ¡å™¨
  "nameserver": [...foreignNameservers], // å›½å¤–DNSæœåŠ¡å™¨
  "proxy-server-nameserver": [...domesticNameservers], // ä»£ç†æœåŠ¡å™¨DNS
  "direct-nameserver": [...domesticNameservers], // ç›´è¿DNS
  "direct-nameserver-follow-policy": false, // ç›´è¿DNSä¸éµå¾ªç­–ç•¥
  "nameserver-policy": {
    "geosite:cn": domesticNameservers // ä¸­å›½ç«™ç‚¹ä½¿ç”¨å›½å†…DNS
  }
};
// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = {
  "type": "http",
  "format": "yaml",
  "interval": 86400
};

// è§„åˆ™é›†é…ç½®
const ruleProviders = {
  "ProxyLite": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://ghproxy.net/raw.githubusercontent.com/tyy840913/backup/refs/heads/main/ACL4SSR/ProxyLite.list",
    "path": "./ruleset/ProxyLite.list",
    "behavior": "classical"
  },
  "Global-Filter": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://ghproxy.net/raw.githubusercontent.com/tyy840913/backup/refs/heads/main/ACL4SSR/Global-Filter.list",
    "path": "./ruleset/Global-Filter.list",
    "behavior": "classical"
  },
  "AI": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://ghproxy.net/raw.githubusercontent.com/tyy840913/backup/refs/heads/main/ACL4SSR/AI.list",
    "path": "./ruleset/AI.list",
    "behavior": "classical"
  }
};

//è§„åˆ™
const rules = [
   "RULE-SET,Global-Filter,ğŸ›‘ å¹¿å‘Šæ‹¦æˆª",
   "RULE-SET,AI,ğŸ’¬ æ™ºèƒ½å¹³å°",
   "RULE-SET,ProxyLite,ğŸŒ ä»£ç†é€‰æ‹©",
   "MATCH,ğŸ¯ å›½å†…ç›´è¿"
];

// ä»£ç†ç»„é€šç”¨é…ç½®
const groupBaseOption = {
  "interval": 300,
  "timeout": 8000,
  "url": "https://www.google.com/generate_204",
  "lazy": true,
  "max-failed-times": 3,
  "hidden": false
};

// ç¨‹åºå…¥å£
function main(config, profileName) {
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0;
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†");
  }

  // è¦†ç›–åŸé…ç½®ä¸­DNSé…ç½®
  config["dns"] = dnsConfig;
  
  // è¦†ç›–åŸé…ç½®ä¸­çš„ä»£ç†ç»„
  config["proxy-groups"] = [
  {
    ...groupBaseOption,
    "name": "ğŸŒ ä»£ç†é€‰æ‹©",
    "type": "select",
    "proxies": ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "ğŸ‘‰ æ‰‹åŠ¨é€‰æ‹©"]
  },
  {
    ...groupBaseOption,
    "name": "â™»ï¸ è‡ªåŠ¨é€‰æ‹©",
    "type": "url-test",
    "include-all": true,
    "interval": 300,
    "tolerance": 30
  },
  {
    ...groupBaseOption,
    "name": "ğŸ‘‰ æ‰‹åŠ¨é€‰æ‹©",
    "type": "select",
    "include-all": true
  },
  {
    ...groupBaseOption,
    "name": "ğŸ’¬ æ™ºèƒ½å¹³å°",
    "include-all": true,
    "filter": '^(?i)(?!.*(?:ä¸­|CN|China|æ¸¯|HK|HongKong|æ¾³|MO|Macao|å°|TW|Taiwan|ä¿„|RU|Russia|Iran|IR|æœ|KP|NorthKorea|Cuba|CU|Syria|SY|Belarus|BY)).*',
    "type": "url-test",
    "interval": 300,
    "tolerance": 30
  },
  {
    ...groupBaseOption,
    "name": "ğŸ›‘ å¹¿å‘Šæ‹¦æˆª",
    "type": "select",
    "proxies": ["REJECT","DIRECT"]
  },
  {
    ...groupBaseOption,
    "name": "ğŸ¯ å›½å†…ç›´è¿",
    "type": "select",
    "proxies": ["DIRECT","REJECT"]
  }
];

  // è¦†ç›–åŸé…ç½®ä¸­çš„è§„åˆ™
  config["rule-providers"] = ruleProviders;
  config["rules"] = rules;

  // è¿”å›ä¿®æ”¹åçš„é…ç½®
  return config;
}
