// ========== 国内 DoH ==========
const domesticNameservers = [
  "https://223.5.5.5/dns-query",          // 阿里-A | 国内最快之一，支持 ECS
  "https://223.6.6.6/dns-query",          // 阿里-B | 同上一致，双节点负载
  "https://119.29.29.29/dns-query",       // 腾讯主 | DNSPod 国内入口，节点多、延迟低
  "https://doh.pub/dns-query",            // 腾讯域 | 备案域名访问，IP 封时救场
  "https://1.12.12.12/dns-query",         // 腾讯备 | 纯 IP 备用，延迟同 119 相近
  "https://120.53.53.53/dns-query",       // 腾讯三 | 又一 Anycast，三节点互为兜底
  "https://114.114.114.114/dns-query"     // 114DNS | 老牌纯净，无广告，稳定 10 年+
];

// ========== 国外 DoH ==========
const foreignNameservers = [
  "https://cloudflare-dns.com/dns-query", // CF 域名 | 全球 Anycast，隐私优先，无日志
  "https://1.1.1.1/dns-query",            // CF-1   | 纯 IP 入口，延迟低
  "https://1.0.0.1/dns-query",            // CF-2   | Cloudflare 备用，双 A 备份
  "https://dns.google/dns-query",         // Google | 自动负载 8.8.8.8/8.8.4.4，支持 ECS
  "https://8.8.8.8/dns-query",            // G-主   | 最常用，解析权威，抗污染
  "https://8.8.4.4/dns-query",            // G-备   | 同上，双节点冗余
  "https://dns.quad9.net/dns-query",      // Quad9  | 自带恶意域拦截，隐私认证
  "https://9.9.9.9/dns-query",            // Q9-主  | 纯 IP，安全过滤
  "https://dns11.quad9.net/dns-query",    // Q9-备  | 次级节点，故障自动切换
  "https://dns.yandex.com/dns-query",     // Yandex | 东欧/中亚优化，国内偶尔抽风
  "https://77.88.8.8/dns-query"           // Y-备   | 纯 IP 入口，兜底使用
];

// DNS配置
const dnsConfig = {
  "enable": true, // 启用DNS
  "listen": "0.0.0.0:1053", // 监听地址和端口
  "ipv6": true, // 支持IPv6
  "prefer-h3": true, // 优先使用HTTP/3
  "respect-rules": true, // 遵循规则
  "use-system-hosts": false, // 不使用系统hosts文件
  "cache-algorithm": "arc", // 缓存算法
  "enhanced-mode": "fake-ip", // 增强模式：伪IP
  "fake-ip-range": "198.18.0.1/16", // 伪IP地址范围
  "fake-ip-filter": [ // 伪IP过滤规则
    // 本地主机/设备
    "+.lan",
    "+.local",
    // Windows网络出现小地球图标
    "+.msftconnecttest.com",
    "+.msftncsi.com",
    // QQ快速登录检测失败
    "localhost.ptlogin2.qq.com",
    "localhost.sec.qq.com",
    // 微信快速登录检测失败
    "localhost.work.weixin.qq.com"
  ],
  "default-nameserver": ["223.5.5.5","1.2.4.8","114.114.114.114","119.29.29.29"], // 默认DNS服务器
  "nameserver": [...foreignNameservers], // 国外DNS服务器
  "proxy-server-nameserver": [...domesticNameservers], // 代理服务器DNS
  "direct-nameserver": [...domesticNameservers], // 直连DNS
  "direct-nameserver-follow-policy": false, // 直连DNS不遵循策略
  "nameserver-policy": {
    "geosite:cn": domesticNameservers // 中国站点使用国内DNS
  }
};
// 规则集通用配置
const ruleProviderCommon = {
  "type": "http",
  "format": "yaml",
  "interval": 86400
};

// 规则集配置
const ruleProviders = {
  "ProxyLite": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://ghproxy.net/raw.githubusercontent.com/tyy840913/backup/refs/heads/main/ACL4SSR/ProxyLite.list",
    "path": "./ruleset/ProxyLite.list",
    "behavior": "classical"
  },
  "Global-Filter": {
    "type": "http",
    "format": "text",
    "interval": 86400,
    "url": "https://ghproxy.net/raw.githubusercontent.com/tyy840913/backup/refs/heads/main/ACL4SSR/Global-Filter.list",
    "path": "./ruleset/Global-Filter.list",
    "behavior": "classical"
  }
};

//规则
const rules = [
   "RULE-SET,Global-Filter,🛑 全球拦截",
   "RULE-SET,ProxyLite,🌍 全球代理",
   "MATCH,🎯 漏网之鱼"
];

// 代理组通用配置
const groupBaseOption = {
  "interval": 300,
  "timeout": 3000,
  "url": "https://www.google.com/generate_204",
  "lazy": true,
  "max-failed-times": 3,
  "hidden": false
};

// 程序入口
function main(config, profileName) {
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0;
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("配置文件中未找到任何代理");
  }

  // 覆盖原配置中DNS配置
  config["dns"] = dnsConfig;
  
  // 覆盖原配置中的代理组
  config["proxy-groups"] = [
  {
    ...groupBaseOption,
    "name": "♻ 自动选择",
    "type": "url-test",
    "include-all": true,
    "interval": 300,
    "tolerance": 50
  },
  {
    ...groupBaseOption,
    "name": "🚀 负载均衡",
    "type": "load-balance",
    "include-all": true,
    "interval": 300,
    "strategy": "round-robin"
  },
  {
    ...groupBaseOption,
    "name": "🌍 全球代理",
    "type": "select",
    "proxies": ["🚀 负载均衡","♻ 自动选择"]
  },
  {
    ...groupBaseOption,
    "name": "🛑 全球拦截",
    "type": "select",
    "proxies": ["REJECT","DIRECT"]
  },
 {
    ...groupBaseOption,
    "name": "🎯 漏网之鱼",
    "type": "select",
    "proxies": ["DIRECT","🌍 全球代理"]
  }
];

  // 覆盖原配置中的规则
  config["rule-providers"] = ruleProviders;
  config["rules"] = rules;

  // 返回修改后的配置
  return config;
}
